generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["driverAdapters"]
}

generator seed {
    provider = "prisma-client-js"
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

enum UserRole {
    SUPER_ADMIN
    ADMIN
    MEMBER
}

enum WorkspaceRole {
    ADMIN
    MEMBER
}

enum ProjectRole {
    ADMIN
    MEMBER
    VIEWER
}

enum TaskStatus {
    TODO
    IN_PROGRESS
    DONE
}

enum TaskType {
    TASK
    BUG
    FEATURE
    IMPROVEMENT
    OTHER
}

enum ProjectStatus {
    ACTIVE
    PLANNING
    COMPLETED
    ON_HOLD
    CANCELLED
}

enum Priority {
    LOW
    MEDIUM
    HIGH
}

model User {
    id             String   @id @default(uuid())
    name           String
    email          String   @unique
    password       String
    role           UserRole @default(MEMBER)
    isActive       Boolean  @default(true)
    image          String   @default("")
    githubToken    String?
    githubUsername String?
    githubData     Json?
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    workspaces      WorkspaceMember[]
    projects        Project[]         @relation("ProjectOwner")
    tasks           Task[]            @relation("TaskAssignee")
    createdTasks    Task[]            @relation("TaskCreatedBy")
    comments        Comment[]
    ownedWorkspaces Workspace[]
    ProjectMember   ProjectMember[]
    sentInvitations WorkspaceInvitation[] @relation("InvitedBy")
    uploadedFiles   File[]
    notifications   Notification[]
    timeEntries     TimeEntry[]
    templates       ProjectTemplate[]
    watchedTasks    TaskWatcher[]
    mentions        Mention[]
}

model Workspace {
    id          String   @id @default(uuid())
    name        String
    slug        String   @unique
    description String?
    settings    Json     @default("{}")
    ownerId     String
    createdAt   DateTime @default(now())
    image_url   String   @default("")
    updatedAt   DateTime @updatedAt

    members     WorkspaceMember[]
    projects    Project[]
    invitations WorkspaceInvitation[]
    owner       User                  @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model WorkspaceMember {
    id          String        @id @default(uuid())
    userId      String
    workspaceId String
    message     String        @default("")
    role        WorkspaceRole @default(MEMBER)
    user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

    @@unique([userId, workspaceId])
}

model WorkspaceInvitation {
    id          String        @id @default(uuid())
    email       String
    token       String        @unique
    role        WorkspaceRole @default(MEMBER)
    workspaceId String
    invitedById String
    expiresAt   DateTime
    acceptedAt  DateTime?
    createdAt   DateTime      @default(now())

    workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    invitedBy   User      @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
}

model Project {
    id          String          @id @default(uuid())
    name        String
    description String?
    priority    Priority        @default(MEDIUM)
    status      ProjectStatus   @default(ACTIVE)
    start_date  DateTime?
    end_date    DateTime?
    team_lead   String
    workspaceId String
    progress    Int             @default(0)
    githubRepo  String?
    githubData  Json?
    budget      Float?
    estimatedHours Float?
    createdAt   DateTime        @default(now())
    updatedAt   DateTime        @updatedAt
    members     ProjectMember[]

    owner          User            @relation("ProjectOwner", fields: [team_lead], references: [id], onDelete: Cascade)
    workspace      Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    tasks          Task[]
    files          File[]
    milestones     Milestone[]
    sprints        Sprint[]
    workflowStates WorkflowState[]
}

model ProjectMember {
    id        String      @id @default(uuid())
    userId    String
    projectId String
    role      ProjectRole @default(MEMBER)
    user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@unique([userId, projectId])
}

model Task {
    id              String     @id @default(uuid())
    projectId       String
    title           String
    description     String?
    status          TaskStatus @default(TODO)
    type            TaskType   @default(TASK)
    priority        Priority   @default(MEDIUM)
    assigneeId      String
    createdById     String
    due_date        DateTime
    estimatedHours  Float?
    milestoneId     String?
    sprintId        String?
    workflowStateId String?
    createdAt       DateTime   @default(now())
    updatedAt       DateTime   @updatedAt

    project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
    assignee      User           @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: Cascade)
    createdBy     User           @relation("TaskCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
    comments      Comment[]
    files         File[]
    timeEntries   TimeEntry[]
    watchers      TaskWatcher[]
    milestone     Milestone?     @relation("TaskMilestone", fields: [milestoneId], references: [id])
    sprint        Sprint?        @relation("TaskSprint", fields: [sprintId], references: [id])
    workflowState WorkflowState? @relation("TaskWorkflowState", fields: [workflowStateId], references: [id])
}

model Comment {
    id        String   @id @default(uuid())
    content   String
    userId    String
    taskId    String
    createdAt DateTime @default(now())

    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    task     Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
    mentions Mention[]
}

model File {
    id           String   @id @default(uuid())
    name         String
    filename     String
    path         String
    size         Int
    mimetype     String
    uploadedById String
    taskId       String?
    projectId    String?
    createdAt    DateTime @default(now())

    uploadedBy User     @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
    task       Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
    project    Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Notification {
    id        String   @id @default(uuid())
    userId    String
    type      String
    title     String
    message   String
    data      Json     @default("{}")
    read      Boolean  @default(false)
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Milestone {
    id          String    @id @default(uuid())
    name        String
    description String?
    dueDate     DateTime
    projectId   String
    completed   Boolean   @default(false)
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    tasks   Task[]  @relation("TaskMilestone")
}

model Sprint {
    id          String    @id @default(uuid())
    name        String
    goal        String?
    startDate   DateTime
    endDate     DateTime
    projectId   String
    active      Boolean   @default(false)
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    tasks   Task[]  @relation("TaskSprint")
}

model TimeEntry {
    id          String   @id @default(uuid())
    description String?
    hours       Float
    date        DateTime @default(now())
    userId      String
    taskId      String
    createdAt   DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model ProjectTemplate {
    id          String   @id @default(uuid())
    name        String
    description String?
    data        Json
    createdById String
    isPublic    Boolean  @default(false)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)
}

model WorkflowState {
    id        String @id @default(uuid())
    name      String
    color     String @default("#gray")
    order     Int
    projectId String
    isDefault Boolean @default(false)

    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
    tasks   Task[]  @relation("TaskWorkflowState")
}

model TaskWatcher {
    id     String @id @default(uuid())
    userId String
    taskId String

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

    @@unique([userId, taskId])
}

model Mention {
    id        String   @id @default(uuid())
    userId    String
    commentId String
    createdAt DateTime @default(now())

    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
}
